<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html
xmlns='http://www.w3.org/1999/xhtml'><head><link
rel='icon' href='data:image/gif;base64,R0lGODlhIAAgAPAAAAAAAAAAACH5BAEAAAEALAAAAAAgACAAAAJFjI+py+0Po5y02quA3rz7zXziGI4mV55nqpIY8r1wJxsxpSX3hNpe9dvxVJjVyyUTJn81H60ZUB6ZTWoVBD3kstyut1sAADs=' /><title>Image in terminal | nullwise</title><meta
http-equiv='Content-Type' content='text/html;charset=utf-8' /><meta
name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no' /><link
rel='stylesheet' href='../../style.css?v=sun_01_may' type='text/css' /><script type='text/javascript' src='../../scripts/images.js'></script><script type='text/javascript'>/*<![CDATA[*/function ol() { var i = document.getElementsByTagName('iframe'); if(i.length > 0 && i[0].hasAttribute('delay_src')) i[0].src = i[0].getAttribute('delay_src'); }/*]]>*/</script></head><body
onload='ol();'><div
class='header'><div
class='menu'><div
class='row page_width'><span
class='entry'><a
href='../../index.html'>Home</a> </span><span
class='entry'><a
href='../../contact.html'>Contact</a> </span></div><div
class='hr'></div></div></div><div
class='content page_width'><div
class='extrabox'><h2>Download</h2><a
class='download' href='imgpreview.tar.gz'><span></span>imgpreview.tar.gz</a></div><h1>Rendering images to a terminal</h1> I came accross this nifty twitter client called <a
class='external' href='http://rainbowstream.org'>Rainbow Stream<span></span></a> which has an option to render images to your terminal. I was curious how this was implemented so I ended up finding their source code, which referenced <a
class='external' href='https://github.com/DTVD/rainbowstream/blob/master/rainbowstream/image.c'>xterm256.c<span></span></a> from <a
class='external' href='https://github.com/jart/fabulous'>Fabulous<span></span></a> which is a python library for printing images, colors and text to the terminal. It seemed like a nice piece of functionality to have in the form of a command-line tool that can be called to preview images on your terminal. So I set out to replicate the image printing functionality as well as make an attempt to improve the image quality.<h2>How does it work?</h2> You can change the foreground and background colors of the text on your terminal by using <a
class='external' href='https://en.wikipedia.org/wiki/ANSI_escape_code'>ANSI escape codes<span></span></a>. In the case of a 256 color terminal you would want to use the following escape codes:<pre><tt style='float: left;'><span class="symbol">\</span><span class="normal">e</span><span class="symbol">[</span><span class="number">38</span><span class="symbol">;</span><span class="number">5</span><span class="symbol">;</span><span class="normal">44m </span><span class="comment">// Change the foreground color to color 44</span>
<span class="symbol">\</span><span class="normal">e</span><span class="symbol">[</span><span class="number">48</span><span class="symbol">;</span><span class="number">5</span><span class="symbol">;</span><span class="normal">44m </span><span class="comment">// Change the background color to color 44</span></tt></pre>If you print these sequences to the terminal any text that follows will use the new colors, so once the entire image has been displayed it would be nice to reset the color back to its default value. This can be done using the following sequence:<pre><tt style='float: left;'><span class="symbol">\</span><span class="normal">e</span><span class="symbol">[</span><span class="normal">0m       </span><span class="comment">// Reset colors to their default values</span></tt></pre><h2>One pixel per glyph</h2> In the first iteration I simply wanted to have one pixel per glyph. This meant I needed to resize the
input image so that one pixel corresponds to one glyph, and since the glyphs on a terminal are not
square I would also need to adjust for this by changing the aspect ratio of the image. Below you can
see the image after it has been resized from its original size of 768x512 in order to fit on a terminal
with 106 columns. Besides resizing the image, the colors from the 24bpp source material have mapped
into the 256 colors provided by the terminal. So when we want to render this resized and recolored
image we simply loop through all the pixels and for each pixel we emit one of the escape codes to
change the background color and then print a space. Also at the end of each row we reset the colors
to their default values and print a newline.<br><pre><tt style='float: left;'><span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">print_one_pixel_per_glyph</span><span class="symbol">(</span><span class="usertype">iRGBAImage</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">image</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">  </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">h</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">w</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> bg </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[48;5;%dm "</span><span class="symbol">,</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">bg</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> bg</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> bg</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[0m</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="cbracket">}</span></tt><div onclick='imageViewer.showImage("macaws_v1.png", "", "")' class='incode_img' style='width: 106px;' ><a onclick='return false;' href='macaws_v1.png'><img style='border: 0px' src='thumbs/macaws_v1.png' alt='' /></a></div></pre><h2>Two pixels per glyph</h2> Up to now only the background color of the terminal has been used. In this iteration I will also use the
foreground color to display a total of two colors per glyph. In order to neatly subdivide each glyph into
two regions we can use unicode <a
class='external' href='https://en.wikipedia.org/wiki/List_of_Unicode_characters#Block_Elements'>Block Elements<span></span></a>. The glyph could be divided in two ways, one
increases horizontal resolution and the other vertical resolution. Because the glyph is taller than wide
we will choose to increase the vertical resolution and get more rectangularly shaped 'pixels'. We
will use the 'Upper half block' glyph '▀', so the upper part of the glyph will receive the foreground
color and the lower half will receive the background color of the terminal. Now that the subpixels are
more rectangular the resized / recolored image below is closer to its original aspect ratio.<br><pre><tt style='float: left;'><span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">print_two_pixels_per_glyph</span><span class="symbol">(</span><span class="usertype">iRGBAImage</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">image</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">  </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">h</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">w</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> fg </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> bg </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">      </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[48;5;%dm</span><span class="specialchar">\e</span><span class="string">[38;5;%dm▀"</span><span class="symbol">,</span>
<span class="normal">        </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">fg</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> fg</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> fg</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">),</span>
<span class="normal">        </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">bg</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> bg</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> bg</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">));</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(\</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[0m</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="cbracket">}</span></tt><div onclick='imageViewer.showImage("macaws_v2.png", "", "")' class='incode_img' style='width: 106px;' ><a onclick='return false;' href='macaws_v2.png'><img style='border: 0px' src='thumbs/macaws_v2.png' alt='' /></a></div></pre><h2>Four pixels per glyph (still just 2 colors though)</h2> With the previous iteration the tool was basically up to par with the image rendering used in Rainbow Stream,
but while implementing it I noticed some of the other unicode block elements such as:<pre>
▛  // Quadrant upper left,  upper right, and lower left
▟  // Quadrant upper right, lower left,  and lower right
▙  // Quadrant upper left,  lower left,  and lower right
▜  // Quadrant upper left,  upper right, and lower right
▞  // Quadrant upper right, and lower left
▌  // Left half block
</pre>Using these glyphs I could maybe increase the horizontal resolution as well. We still need to print 106 glyphs
per column, but for every glyph four image pixels need to be considered. To choose the glyph we simply do a
pattern match on the configuration of the colors in the corresponding 2x2 section. In the case that there are
two or less colors this works fine, but in the case that there are more than two colors it is not possible to
find a match so we simply do a linear blend of the pixels in the top row of the 2x2 section and the same for
the bottom row, and then use the '▀' glyph with the resulting two colors.<pre><tt style='float: left;'><span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">set_color</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> fg_color</span><span class="symbol">,</span><span class="normal"> </span><span class="type">int</span><span class="normal"> bg_color</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">  </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[38;5;%dm</span><span class="specialchar">\e</span><span class="string">[48;5;%dm"</span><span class="symbol">,</span><span class="normal"> fg_color</span><span class="symbol">,</span><span class="normal"> bg_color</span><span class="symbol">);</span>
<span class="cbracket">}</span>

<span class="keyword">static</span><span class="normal"> </span><span class="type">void</span><span class="normal"> </span><span class="function">print_four_pixels_per_glyph</span><span class="symbol">(</span><span class="usertype">iRGBAImage</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">image</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">  </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> y </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">h</span><span class="symbol">;</span><span class="normal"> y </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">for</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> x </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">&lt;</span><span class="normal"> image</span><span class="symbol">-&gt;</span><span class="normal">w</span><span class="symbol">;</span><span class="normal"> x </span><span class="symbol">+=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> tl </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">,</span><span class="normal">   y</span><span class="symbol">);</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> tr </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">);</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> bl </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">,</span><span class="normal">   y</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">      </span><span class="usertype">iRGBA</span><span class="normal"> br </span><span class="symbol">=</span><span class="normal"> </span><span class="function">image_color_at</span><span class="symbol">(</span><span class="normal">image</span><span class="symbol">,</span><span class="normal"> x</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> y</span><span class="symbol">+</span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">      </span><span class="type">int</span><span class="normal"> c1 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">tl</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> tl</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> tl</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> c2 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">tr</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> tr</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> tr</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> c3 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">bl</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> bl</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> bl</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">      </span><span class="type">int</span><span class="normal"> c4 </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">br</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> br</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> br</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>

<span class="normal">      </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c1 </span><span class="symbol">==</span><span class="normal"> c2 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c2 </span><span class="symbol">==</span><span class="normal"> c3 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c1 </span><span class="symbol">!=</span><span class="normal"> c4</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c4</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▛"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c2 </span><span class="symbol">==</span><span class="normal"> c3 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c3 </span><span class="symbol">==</span><span class="normal"> c4 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c1 </span><span class="symbol">!=</span><span class="normal"> c2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c4</span><span class="symbol">,</span><span class="normal"> c1</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▟"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c3 </span><span class="symbol">==</span><span class="normal"> c4 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c4 </span><span class="symbol">==</span><span class="normal"> c1 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c1 </span><span class="symbol">!=</span><span class="normal"> c2</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c2</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▙"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c1 </span><span class="symbol">==</span><span class="normal"> c2 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c2 </span><span class="symbol">==</span><span class="normal"> c4 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c1 </span><span class="symbol">!=</span><span class="normal"> c3</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c3</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▜"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c1 </span><span class="symbol">==</span><span class="normal"> c2 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c3 </span><span class="symbol">==</span><span class="normal"> c4</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c3</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▀"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c1 </span><span class="symbol">==</span><span class="normal"> c3 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c2 </span><span class="symbol">==</span><span class="normal"> c4</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c2</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▌"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="keyword">if</span><span class="symbol">(</span><span class="normal">c1 </span><span class="symbol">==</span><span class="normal"> c4 </span><span class="symbol">&amp;&amp;</span><span class="normal"> c2 </span><span class="symbol">==</span><span class="normal"> c3</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">c1</span><span class="symbol">,</span><span class="normal"> c2</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▚"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="usertype">iRGBA</span><span class="normal"> top </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tl</span><span class="symbol">.</span><span class="normal">r </span><span class="symbol">+</span><span class="normal"> tr</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tl</span><span class="symbol">.</span><span class="normal">g </span><span class="symbol">+</span><span class="normal"> tr</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">tl</span><span class="symbol">.</span><span class="normal">b </span><span class="symbol">+</span><span class="normal"> tr</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">        </span><span class="usertype">iRGBA</span><span class="normal"> btm </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bl</span><span class="symbol">.</span><span class="normal">r </span><span class="symbol">+</span><span class="normal"> br</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bl</span><span class="symbol">.</span><span class="normal">g </span><span class="symbol">+</span><span class="normal"> br</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">bl</span><span class="symbol">.</span><span class="normal">b </span><span class="symbol">+</span><span class="normal"> br</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">/</span><span class="normal"> </span><span class="number">2</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0xff</span><span class="normal"> </span><span class="cbracket">}</span><span class="symbol">;</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> top_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">top</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> top</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> top</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">        </span><span class="type">int</span><span class="normal"> btm_id </span><span class="symbol">=</span><span class="normal"> </span><span class="function">rgb_to_xterm</span><span class="symbol">(</span><span class="normal">btm</span><span class="symbol">.</span><span class="normal">r</span><span class="symbol">,</span><span class="normal"> btm</span><span class="symbol">.</span><span class="normal">g</span><span class="symbol">,</span><span class="normal"> btm</span><span class="symbol">.</span><span class="normal">b</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">set_color</span><span class="symbol">(</span><span class="normal">top_id</span><span class="symbol">,</span><span class="normal"> btm_id</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"▀"</span><span class="symbol">);</span>
<span class="normal">      </span><span class="cbracket">}</span>

<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"</span><span class="specialchar">\e</span><span class="string">[0m</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">);</span>
<span class="normal">  </span><span class="cbracket">}</span>
<span class="cbracket">}</span></tt><div onclick='imageViewer.showImage("macaws_v3.png", "", "")' class='incode_img' style='width: 213px;' ><a onclick='return false;' href='macaws_v3.png'><img style='border: 0px' src='thumbs/macaws_v3.png' alt='' /></a></div></pre><h2>Dithering?</h2> Another thing I thought that might improve the rendering was to use dithering in order to remove the <a
class='external' href='https://en.wikipedia.org/wiki/Colour_banding'>Color banding<span></span></a> . I used <a
class='external' href='https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering'>Floyd-Steinberg dithering<span></span></a>, as you can see in the preview below the color banding seems
to have been considerably reduced. However in the expanded image the effect is not as nice. The pixels are
no longer small enough to have the same effect, and instead it seems to make the image more noisy. Whether
the use of dithering is beneficial in this case may depend on personal preference.<div
onclick='imageViewer.showImage("macaws_v4.png", "", "")' class='cscs' style='width: 213px;' ><a
onclick='return false;' href='macaws_v4.png'><img
style='border: 0px' src='thumbs/macaws_v4.png' alt='' /></a></div><h2>True color support</h2> An alternative solution to the banding problem is to simply use a terminal emulator that supports true color display. In terminals
that support it you can use the following escape codes to set the foreground and background colors:<pre><tt style='float: left;'><span class="symbol">\</span><span class="normal">e</span><span class="symbol">[</span><span class="number">38</span><span class="symbol">;</span><span class="number">2</span><span class="symbol">;</span><span class="number">255</span><span class="symbol">;</span><span class="number">255</span><span class="symbol">;</span><span class="normal">255m </span><span class="comment">// Change the foreground color to color white</span>
<span class="symbol">\</span><span class="normal">e</span><span class="symbol">[</span><span class="number">48</span><span class="symbol">;</span><span class="number">2</span><span class="symbol">;</span><span class="number">255</span><span class="symbol">;</span><span class="number">255</span><span class="symbol">;</span><span class="normal">255m </span><span class="comment">// Change the background color to color white</span></tt></pre><h2>Implementation</h2> In order to implement this small tool I used <a
class='external' href='https://github.com/nothings/stb'>stb_image.h<span></span></a> for image loading and xterm256.c for color
conversion. The test image was downloaded from the <a
class='external' href='http://r0k.us/graphics/kodak/'>Kodak Lossless True Color Image Suite<span></span></a>. If you want to try it out for yourself you can download it here: <a
class='download' href='imgpreview.tar.gz'><span></span>imgpreview.tar.gz</a>. Compilation should
hopefully be as simple as running the packaged build.sh script which should result in the imgpreview executable.
You can get information about the usage by running it without any arguments.<h2>References</h2>[1] <a
class='external' href='http://rainbowstream.org'>Rainbow Stream<span></span></a><br>[2] <a
class='external' href='https://github.com/DTVD/rainbowstream/blob/master/rainbowstream/image.c'>xterm256.c<span></span></a><br>[3] <a
class='external' href='https://github.com/jart/fabulous'>Fabulous<span></span></a><br>[4] <a
class='external' href='https://en.wikipedia.org/wiki/ANSI_escape_code'>ANSI escape codes<span></span></a><br>[5] <a
class='external' href='https://en.wikipedia.org/wiki/List_of_Unicode_characters#Block_Elements'>Block Elements<span></span></a><br>[6] <a
class='external' href='https://en.wikipedia.org/wiki/Colour_banding'>Color banding<span></span></a><br>[7] <a
class='external' href='https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering'>Floyd-Steinberg dithering<span></span></a><br>[8] <a
class='external' href='https://github.com/nothings/stb'>stb_image.h<span></span></a><br>[9] <a
class='external' href='http://r0k.us/graphics/kodak/'>Kodak Lossless True Color Image Suite<span></span></a><br><div
style='clear: both'></div></div></body></html>